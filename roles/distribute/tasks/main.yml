---
- name: Ensure required directories exist
  become: true
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ dest_certs_dir }}"
    - "{{ etcd_dir }}"

- name: Create reset-env.sh script for cleaning up Kubernetes/etcd files
  become: true
  copy:
    dest: "/home/apostoliseq/reset-env.sh"
    content: |
      #!/bin/bash

      # Brutal Force-Kill
      for service in etcd kube-apiserver kube-controller-manager kube-scheduler; do \
        sudo systemctl stop $service.service
        sudo systemctl disable $service.service
      done

      # Clean Kubernetes and etcd files
      sudo rm -rf \
        {{ dest_certs_dir }} \
        {{ etcd_dir }} \
        /etc/systemd/system/etcd.service \
        /etc/systemd/system/kube-* \
        /var/lib/kubernetes/*
      
      # Clean binaries
      sudo rm -rf /usr/local/bin/*

      echo "Environment reset complete"
    mode: 0755

- name: Distribute to controller
  ansible.builtin.include_tasks:
    file: controller.yml
  when: "'controller' in inventory_hostname"

- name: Distribute to worker
  ansible.builtin.include_tasks:
    file: worker.yml
  when: "'worker' in inventory_hostname"

- name: Distribute to loadbalancer
  ansible.builtin.include_tasks:
    file: loadbalancer.yml
  when: "'loadbalancer' in inventory_hostname"